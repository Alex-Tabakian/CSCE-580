      - name: Fix notebooks (add missing widget state)
        id: fix
        run: |
          cat > fix_notebooks.py <<'PY'
#!/usr/bin/env python3
import nbformat
import shutil
import sys
from pathlib import Path

def main():
    changed_any = False
    # Look specifically in ProjectB, but also check repo for ipynb files
    notebooks = list(Path('ProjectB').rglob('*.ipynb'))
    # fallback: discover other notebooks (avoid duplicating ProjectB entries)
    for p in Path('.').rglob('*.ipynb'):
        if 'ProjectB' not in str(p):
            notebooks.append(p)
    # Deduplicate
    seen = set()
    uniq = []
    for p in notebooks:
        sp = str(p.resolve())
        if sp not in seen:
            seen.add(sp)
            uniq.append(p)
    notebooks = uniq

    if not notebooks:
        print("No notebooks found.")
        return 0

    print("Notebooks to check:")
    for p in notebooks:
        print(" -", p)

    for p in notebooks:
        try:
            print("Checking", p)
            bak = p.with_suffix(p.suffix + ".bak")
            shutil.copy2(p, bak)
            nb = nbformat.read(str(p), as_version=nbformat.NO_CONVERT)
            widgets = nb.metadata.get("widgets")
            changed = False
            if widgets is None:
                print("  no metadata.widgets found for", p)
            elif isinstance(widgets, list):
                for w in widgets:
                    if isinstance(w, dict) and "state" not in w:
                        w["state"] = {}
                        changed = True
                nb.metadata["widgets"] = widgets
            elif isinstance(widgets, dict):
                # handle mapping case
                if "application/vnd.jupyter.widget-state+json" in widgets:
                    mapping = widgets["application/vnd.jupyter.widget-state+json"]
                    for k, v in mapping.items():
                        if isinstance(v, dict) and "state" not in v:
                            v["state"] = {}
                            changed = True
                    nb.metadata["widgets"] = widgets
                else:
                    if "state" not in widgets:
                        nb.metadata["widgets"]["state"] = {}
                        changed = True
            else:
                nb.metadata.pop("widgets", None)
                changed = True

            if changed:
                nbformat.write(nb, str(p))
                print("  Fixed:", p)
                changed_any = True
            else:
                print("  No changes required for", p)
        except Exception as e:
            print("Error processing", p, e)

    if changed_any:
        print("One or more notebooks were changed.")
    else:
        print("No notebooks needed changes.")
    return 0

if __name__ == '__main__':
    sys.exit(main())
PY

          python fix_notebooks.py
