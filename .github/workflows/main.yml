name: Fix notebooks metadata.widgets

on:
  push:
    paths:
      - "**/*.ipynb"
  workflow_dispatch:

jobs:
  fix-notebooks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install nbformat
        run: python -m pip install --upgrade pip nbformat

      - name: Show repo tree (for debugging)
        run: |
          echo "PWD: $(pwd)"
          ls -la
          echo "Notebooks found:"
          find . -maxdepth 4 -type f -name "*.ipynb" -print || true

      - name: Fix notebooks (add missing widget state)
        id: fix
        run: |
          cat > fix_notebooks.py <<'PY'
#!/usr/bin/env python3
import nbformat
import shutil
import sys
from pathlib import Path

def main():
    changed_any = False

    # Collect notebooks in ProjectB first, then any other notebooks
    notebooks = list(Path('ProjectB').rglob('*.ipynb'))
    for p in Path('.').rglob('*.ipynb'):
        if 'ProjectB' not in str(p):
            notebooks.append(p)

    # Deduplicate
    seen = set()
    uniq = []
    for p in notebooks:
        sp = str(p.resolve())
        if sp not in seen:
            seen.add(sp)
            uniq.append(p)
    notebooks = uniq

    if not notebooks:
        print("No notebooks found.")
        return 0

    print("Notebooks to check:")
    for p in notebooks:
        print(" -", p)

    for p in notebooks:
        try:
            print("Checking", p)
            bak = p.with_suffix(p.suffix + ".bak")
            shutil.copy2(p, bak)
            nb = nbformat.read(str(p), as_version=nbformat.NO_CONVERT)
            widgets = nb.metadata.get("widgets")
            changed = False

            if widgets is None:
                print("  no metadata.widgets found for", p)
            elif isinstance(widgets, list):
                for w in widgets:
                    if isinstance(w, dict) and "state" not in w:
                        w["state"] = {}
                        changed = True
                nb.metadata["widgets"] = widgets
            elif isinstance(widgets, dict):
                if "application/vnd.jupyter.widget-state+json" in widgets:
                    mapping = widgets["application/vnd.jupyter.widget-state+json"]
                    for k, v in mapping.items():
                        if isinstance(v, dict) and "state" not in v:
                            v["state"] = {}
                            changed = True
                    nb.metadata["widgets"] = widgets
                else:
                    if "state" not in widgets:
                        nb.metadata["widgets"]["state"] = {}
                        changed = True
            else:
                nb.metadata.pop("widgets", None)
                changed = True

            if changed:
                nbformat.write(nb, str(p))
                print("  Fixed:", p)
                changed_any = True
            else:
                print("  No changes required for", p)
        except Exception as e:
            print("Error processing", p, e)

    if changed_any:
        print("One or more notebooks were changed.")
    else:
        print("No notebooks needed changes.")
    return 0

if __name__ == '__main__':
    sys.exit(main())
PY

          python fix_notebooks.py

      - name: Show git status & diff
        run: |
          git status --porcelain
          echo "---- Unstaged diff (if any) ----"
          git --no-pager diff || true

      - name: Commit and push fixes (if any)
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          # commit only if there are staged changes
          if ! git diff --cached --quiet; then
            git commit -m "ci: fix notebook metadata.widgets missing state" || true
            git push || echo "Push failed (branch protection or permission). Download artifact and apply manually."
          else
            echo "No changes to commit"

      - name: Upload fixed notebooks (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fixed-notebooks
          path: |
            ProjectB/**/*.ipynb
            **/*.ipynb.bak
            **/*.ipynb
